#!/bin/bash
#
# Ships' bells and watch script.
# Version for OS X.
#
# Displays the number of bells. Optionally displays the current watch,
# a popup (requires Growl and growlnotify),
# or rings bells (requires afplay, {1..8}bells.mp3 files).
#
# Use with the following cron entry:
# 0,30 * * * * /bin/bash /path/to/script

usage() {
  echo "Usage: ${0##*/} [options]"
  echo
  echo "With no arguments, outputs the number of bells in the current watch."
  echo
  echo "Options:"
  echo "  -b        print visual indicator for the number of bells ('*')"
  echo "  -w        print the current watch"
  echo "  -m        mute sounding of bells; again to undo"
  echo "  -M        mute ALL output from onwatch; again to undo"
  echo "  -n        post-Nore Mutiny Dog watches"
  echo "  -p        show popup notification (requires Growl and growlnotify)"
  echo "  -s        sound bells (requires afplay, {1..8}bells.mp3 files"
  echo "  -q        do NOT print to stdout; other display options unaffected"
  echo "  -d date   show bells for 'date'"
  echo "  -h        print this help and exit"
  echo
  echo "All other options are ignored."
}

MUTE=/tmp/onwatch_mute
MUTE_ALL=/tmp/onwatch_mute_all

# Process command line arguments
while getopts :bwmMnpsqd:h opt; do
  case "$opt" in
    b)  SHOW_BELLS=1 ;;
    w)  SHOW_WATCH=1 ;;
    m)  [[ -f "$MUTE" ]] && rm "$MUTE" || touch "$MUTE" ;;
    M)  [[ -f "$MUTE_ALL" ]] && rm "$MUTE_ALL" || touch "$MUTE_ALL" ;;
    n)  NORE=1 ;;
    p)  POPUP=1 ;;
    s)  SOUND=1 ;;
    q)  QUIET=1 ;;
    d)  DATE="$OPTARG" ;;
    h)  usage && exit 0 ;;
  esac
done

[[ -f "$MUTE_ALL" ]] && exit 0

# Watch names
WATCH[0]="Morning Watch"
WATCH[1]="Middle Watch"
WATCH[2]="Forenoon Watch"
WATCH[3]="Afternoon Watch"
WATCH[4]="Dog Watch"
WATCH[5]="First Watch"
WATCH[6]="First Dog Watch"
WATCH[7]="Last Dog Watch"

# Path to {1..8}bells.mp3 files.
BELLS_DIR="${HOME}/.local/share/onwatch"


# Calculate time and bells
[[ -n "$DATE" ]] && clock=( $(date -d "$DATE" +"%H %M %j") ) \
  || clock=( $(date +"%H %M %j") )
hour=${clock[0]}
minute=${clock[1]}
day=${clock[2]}
bells=$(( 10#$hour % 4 * 2 + 10#$minute / 30 ))
watch=$(( 10#$hour / 4 ))

# Special case: eight bells, still previous watch
[[ "$(( 10#$hour % 4 + 10#$minute ))" -eq 0 ]] && bells=8 \
  && watch=$(( ($watch + 5) % 6 ))

# Special case: New Year, ring eight bells twice
[[ "$day" -eq 1 ]] && [[ "$hour" -eq 0 ]] && [[ "$minute" -eq 0 ]] \
  && bells=16

# Special case: post-Nore mutiny style Dog watches
if [[ "$watch" -eq 4 ]] && [[ -n "$NORE" ]]; then
  if [[ "${hour}${minute}" -le 1800 ]]; then
    watch=6
  elif [[ "${hour}${minute}" -lt 2000 ]]; then
    watch=7
    bells=$(( $bells % 4 ))
  else # Time is 2000 exactly
    watch=7
  fi
fi

# Compose visual bells indicator
if [[ -n "$SHOW_BELLS" ]]; then
  for ((bell=1; bell<bells; bell+=2)); do
    output="${output}** "
  done
  [[ "$(( $bells % 2 ))" -ne 0 ]] && output="${output}*  "
  for ((bell=7; bell>bells; bell-=2)); do
    output="${output}   "
  done
else
  [[ "$bells" -eq 1 ]] && output="$bells bell " || output="$bells bells "
fi

# Append watch name
[[ -n "$SHOW_WATCH" ]] && output="${output}${WATCH[$watch]}"

# Display xmessage popup, if possible
[[ -n "$POPUP" ]] && /usr/local/bin/growlnotify --message "$output"

# Play bell sounds
if [[ -n "$SOUND" ]] && [[ ! -f "$MUTE" ]]; then
  # Get system volume
  vol="$(osascript -e "get volume settings" | cut -d, -f1 | cut -d: -f2)"
  [[ "$vol" -ne 0 ]] && \
    afplay -v $(echo "scale=2; 1 / $vol" | bc) ${BELLS_DIR}/${bells}bells.mp3
fi

# Output to stdout
[[ -z "$QUIET" ]] && echo "$output"

