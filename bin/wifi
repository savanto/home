#!/bin/bash
#
# Script to connect to wireless networks.
# Uses wpa_supplicant and dhclient
# TODO unsecured/insecure networks
#

set -e

[[ $UID -ne 0 ]] && echo "Must be root." && exit 1

usage() {
  echo "Usage: ${0##*/} [-h] [-c config|<ssid> <pass>]"
  echo
  echo "-c config       Config file with network setup info."
  echo "<ssid> <pass>   Network and passphrase to use. Passphrase must be 8..63"
  echo "                characters."
  echo "-h              Print this message and exit."
  echo "---             ---"
  echo "                With no arguments, the output of 'pass misc/wifi.conf'"
  echo "                will be used as the WPA config."
}

IFACE=wlan0
WIFI=/run/user/$(id -u $SUDO_USER)/wifi.conf

while getopts c:h opt; do
  case "$opt" in
    c) CONF="$OPTARG" ;;
    h) usage && exit ;;
  esac
done

trap "shred -zu $WIFI 2>/dev/null" ERR INT
if [[ -r "$CONF" ]]; then
  (umask 0077 && cat "$CONF" >"$WIFI")
elif [[ $# -eq 2 ]]; then
  (umask 0077 && wpa_passphrase "$1" "$2" >"$WIFI") \
    || echo "Bad ssid or passphrase." && exit 1
else
  (umask 0077 && pass misc/wifi.conf >"$WIFI")
fi

killall wpa_supplicant 2>/dev/null || true
dhclient -r "$IFACE" || true
wpa_supplicant -Dnl80211,wext -i"$IFACE" -c"$WIFI" -B
dhclient "$IFACE"
